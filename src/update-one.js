"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const aws_sdk_1 = require("aws-sdk");
const AWS = require('aws-sdk');
const stepFunctions = new AWS.StepFunctions();
const SORT_KEY = process.env.SORT_KEY || '';
const STATE_MACHINE_ARN = process.env.STATE_MACHINE_ARN || '';
const headers = {
    'Access-Control-Allow-Origin': '*'
};
// Promised based version https://stackoverflow.com/questions/49244134/starting-a-stepfunction-and-exiting-doesnt-trigger-execution
const clients = {
    stepFunctions: new aws_sdk_1.StepFunctions()
};
const createExecutor = ({ clients }) => async (event) => {
    console.log('Executing media pipeline job ' + JSON.stringify(event, null, 2));
    console.log('Executing media pipeline job ' + JSON.stringify(clients, null, 2));
    var item = typeof event.body === 'object' ? event.body : JSON.parse(event.body);
    console.debug("update-one event: " + JSON.stringify(event));
    item[SORT_KEY] = event.pathParameters[SORT_KEY];
    const params = {
        stateMachineArn: STATE_MACHINE_ARN,
        input: JSON.stringify({ item: item })
    };
    await stepFunctions.startExecution(params).promise();
    return item;
};
const startExecution = createExecutor({ clients });
exports.handler = async (event = {}) => {
    // Pass in the event from the Lambda e.g S3 Put, SQS Message
    await startExecution(event);
    return { statusCode: 200, body: JSON.stringify({}), isBase64Encoded: false, headers: headers };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBkYXRlLW9uZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInVwZGF0ZS1vbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxxQ0FBd0M7QUFDeEMsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQy9CLE1BQU0sYUFBYSxHQUFHLElBQUksR0FBRyxDQUFDLGFBQWEsRUFBRSxDQUFDO0FBQzlDLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQztBQUU1QyxNQUFNLGlCQUFpQixHQUFXLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLElBQUksRUFBRSxDQUFBO0FBRXJFLE1BQU0sT0FBTyxHQUFHO0lBQ2QsNkJBQTZCLEVBQUUsR0FBRztDQUNuQyxDQUFBO0FBRUQsbUlBQW1JO0FBRW5JLE1BQU0sT0FBTyxHQUFHO0lBQ2QsYUFBYSxFQUFFLElBQUksdUJBQWEsRUFBRTtDQUNuQyxDQUFBO0FBRUQsTUFBTSxjQUFjLEdBQUcsQ0FBQyxFQUFFLE9BQU8sRUFBTSxFQUFFLEVBQUUsQ0FBQyxLQUFLLEVBQUUsS0FBVSxFQUFFLEVBQUU7SUFDL0QsT0FBTyxDQUFDLEdBQUcsQ0FBQywrQkFBK0IsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUcsQ0FBQztJQUNoRixPQUFPLENBQUMsR0FBRyxDQUFDLCtCQUErQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBRyxDQUFDO0lBQ2xGLElBQUksSUFBSSxHQUFRLE9BQU8sS0FBSyxDQUFDLElBQUksS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRXJGLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBRTVELElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxLQUFLLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBRWhELE1BQU0sTUFBTSxHQUFHO1FBQ2IsZUFBZSxFQUFFLGlCQUFpQjtRQUNsQyxLQUFLLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFDLElBQUksRUFBRSxJQUFJLEVBQUMsQ0FBQztLQUNwQyxDQUFDO0lBQ0YsTUFBTSxhQUFhLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3JELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQyxDQUFDO0FBRUYsTUFBTSxjQUFjLEdBQUcsY0FBYyxDQUFDLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztBQUV0QyxRQUFBLE9BQU8sR0FBRyxLQUFLLEVBQUUsUUFBYSxFQUFFLEVBQWdCLEVBQUU7SUFFN0QsNERBQTREO0lBQzVELE1BQU0sY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRTVCLE9BQU8sRUFBQyxVQUFVLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxFQUFFLGVBQWUsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBQyxDQUFDO0FBQy9GLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN0ZXBGdW5jdGlvbnMgfSBmcm9tICdhd3Mtc2RrJztcbmNvbnN0IEFXUyA9IHJlcXVpcmUoJ2F3cy1zZGsnKTtcbmNvbnN0IHN0ZXBGdW5jdGlvbnMgPSBuZXcgQVdTLlN0ZXBGdW5jdGlvbnMoKTtcbmNvbnN0IFNPUlRfS0VZID0gcHJvY2Vzcy5lbnYuU09SVF9LRVkgfHwgJyc7XG5cbmNvbnN0IFNUQVRFX01BQ0hJTkVfQVJOOiBzdHJpbmcgPSBwcm9jZXNzLmVudi5TVEFURV9NQUNISU5FX0FSTiB8fCAnJ1xuXG5jb25zdCBoZWFkZXJzID0ge1xuICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonXG59XG5cbi8vIFByb21pc2VkIGJhc2VkIHZlcnNpb24gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNDkyNDQxMzQvc3RhcnRpbmctYS1zdGVwZnVuY3Rpb24tYW5kLWV4aXRpbmctZG9lc250LXRyaWdnZXItZXhlY3V0aW9uXG5cbmNvbnN0IGNsaWVudHMgPSB7XG4gIHN0ZXBGdW5jdGlvbnM6IG5ldyBTdGVwRnVuY3Rpb25zKClcbn1cblxuY29uc3QgY3JlYXRlRXhlY3V0b3IgPSAoeyBjbGllbnRzIH06YW55KSA9PiBhc3luYyAoZXZlbnQ6IGFueSkgPT4ge1xuICBjb25zb2xlLmxvZygnRXhlY3V0aW5nIG1lZGlhIHBpcGVsaW5lIGpvYiAnICsgSlNPTi5zdHJpbmdpZnkoZXZlbnQsIG51bGwsIDIpICApO1xuICBjb25zb2xlLmxvZygnRXhlY3V0aW5nIG1lZGlhIHBpcGVsaW5lIGpvYiAnICsgSlNPTi5zdHJpbmdpZnkoY2xpZW50cywgbnVsbCwgMikgICk7XG4gIHZhciBpdGVtOiBhbnkgPSB0eXBlb2YgZXZlbnQuYm9keSA9PT0gJ29iamVjdCcgPyBldmVudC5ib2R5IDogSlNPTi5wYXJzZShldmVudC5ib2R5KTtcblxuICBjb25zb2xlLmRlYnVnKFwidXBkYXRlLW9uZSBldmVudDogXCIgKyBKU09OLnN0cmluZ2lmeShldmVudCkpO1xuXG4gIGl0ZW1bU09SVF9LRVldID0gZXZlbnQucGF0aFBhcmFtZXRlcnNbU09SVF9LRVldO1xuXG4gIGNvbnN0IHBhcmFtcyA9IHtcbiAgICBzdGF0ZU1hY2hpbmVBcm46IFNUQVRFX01BQ0hJTkVfQVJOLFxuICAgIGlucHV0OiBKU09OLnN0cmluZ2lmeSh7aXRlbTogaXRlbX0pXG4gIH07XG4gIGF3YWl0IHN0ZXBGdW5jdGlvbnMuc3RhcnRFeGVjdXRpb24ocGFyYW1zKS5wcm9taXNlKCk7XG4gIHJldHVybiBpdGVtO1xufTtcblxuY29uc3Qgc3RhcnRFeGVjdXRpb24gPSBjcmVhdGVFeGVjdXRvcih7IGNsaWVudHMgfSk7XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBhbnkgPSB7fSk6IFByb21pc2U8YW55PiA9PiB7XG5cbiAgLy8gUGFzcyBpbiB0aGUgZXZlbnQgZnJvbSB0aGUgTGFtYmRhIGUuZyBTMyBQdXQsIFNRUyBNZXNzYWdlXG4gIGF3YWl0IHN0YXJ0RXhlY3V0aW9uKGV2ZW50KTtcblxuICByZXR1cm4ge3N0YXR1c0NvZGU6IDIwMCwgYm9keTogSlNPTi5zdHJpbmdpZnkoe30pLCBpc0Jhc2U2NEVuY29kZWQ6IGZhbHNlLCBoZWFkZXJzOiBoZWFkZXJzfTtcbn1cbiJdfQ==