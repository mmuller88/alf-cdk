"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const core_1 = require("@aws-cdk/core");
const aws_lambda_1 = require("@aws-cdk/aws-lambda");
const AlfCdkTables_1 = require("./AlfCdkTables");
const aws_logs_1 = require("@aws-cdk/aws-logs");
const aws_iam_1 = require("@aws-cdk/aws-apigateway/node_modules/@aws-cdk/aws-iam");
const CI_USER_TOKEN = process.env.CI_USER_TOKEN || '';
;
class AlfCdkLambdas {
    constructor(scope, props) {
        var _a;
        this.getOneLambda = new aws_lambda_1.Function(scope, 'getOneItemFunction', {
            code: new aws_lambda_1.AssetCode('../src'),
            handler: 'get-one.handler',
            runtime: aws_lambda_1.Runtime.NODEJS_10_X,
            environment: {
                TABLE_NAME: AlfCdkTables_1.instanceTable.name,
                PRIMARY_KEY: AlfCdkTables_1.instanceTable.primaryKey,
                SORT_KEY: AlfCdkTables_1.instanceTable.sortKey
            },
            logRetention: aws_logs_1.RetentionDays.ONE_DAY,
        });
        this.getAllLambda = new aws_lambda_1.Function(scope, 'getAllItemsFunction', {
            code: new aws_lambda_1.AssetCode('../src'),
            handler: 'get-all.handler',
            runtime: aws_lambda_1.Runtime.NODEJS_10_X,
            environment: {
                TABLE_NAME: AlfCdkTables_1.instanceTable.name,
                PRIMARY_KEY: AlfCdkTables_1.instanceTable.primaryKey
            },
            logRetention: aws_logs_1.RetentionDays.ONE_DAY,
        });
        const role = new aws_iam_1.Role(scope, 'Role', {
            assumedBy: new aws_iam_1.ServicePrincipal('lambda.amazonaws.com'),
            managedPolicies: [aws_iam_1.ManagedPolicy.fromAwsManagedPolicyName('service-role/AWSLambdaBasicExecutionRole')],
        });
        role.addToPolicy(new aws_iam_1.PolicyStatement({
            resources: ['*'],
            actions: ['ec2:*', 'logs:*']
        }));
        this.getAllInstancesLambda = new aws_lambda_1.Function(scope, 'getAllInstancesFunction', {
            code: new aws_lambda_1.AssetCode('../src'),
            handler: 'get-all-instances.handler',
            runtime: aws_lambda_1.Runtime.NODEJS_10_X,
            environment: {
                PRIMARY_KEY: AlfCdkTables_1.instanceTable.primaryKey,
                SORT_KEY: AlfCdkTables_1.instanceTable.sortKey,
                STACK_NAME: scope.stackName
            },
            role: role,
            logRetention: aws_logs_1.RetentionDays.ONE_DAY,
        });
        this.deleteOne = new aws_lambda_1.Function(scope, 'deleteItemFunction', {
            code: new aws_lambda_1.AssetCode('../src'),
            handler: 'delete-one.handler',
            runtime: aws_lambda_1.Runtime.NODEJS_10_X,
            environment: {
                TABLE_NAME: AlfCdkTables_1.instanceTable.name,
                PRIMARY_KEY: AlfCdkTables_1.instanceTable.primaryKey,
                SORT_KEY: AlfCdkTables_1.instanceTable.sortKey
            },
            logRetention: aws_logs_1.RetentionDays.ONE_DAY,
        });
        this.putOneItemLambda = new aws_lambda_1.Function(scope, 'putOneItem', {
            code: new aws_lambda_1.AssetCode('../src'),
            handler: 'create.handler',
            runtime: aws_lambda_1.Runtime.NODEJS_10_X,
            environment: {
                TABLE_NAME: AlfCdkTables_1.instanceTable.name,
                PRIMARY_KEY: AlfCdkTables_1.instanceTable.primaryKey,
                SORT_KEY: AlfCdkTables_1.instanceTable.sortKey
            },
            logRetention: aws_logs_1.RetentionDays.ONE_DAY,
        });
        this.createInstanceLambda = new aws_lambda_1.Function(scope, 'createInstance', {
            code: new aws_lambda_1.AssetCode('../src'),
            handler: 'create-instance.handler',
            runtime: aws_lambda_1.Runtime.NODEJS_10_X,
            environment: {
                REPO_TABLE: AlfCdkTables_1.repoTable.name,
                PRIMARY_KEY: AlfCdkTables_1.repoTable.primaryKey,
                CI_USER_TOKEN: CI_USER_TOKEN,
                SECURITY_GROUP: 'default',
                STACK_NAME: scope.stackName,
                IMAGE_ID: ((_a = props) === null || _a === void 0 ? void 0 : _a.imageId) || ''
            },
            role: role,
            logRetention: aws_logs_1.RetentionDays.ONE_DAY,
        });
        this.checkCreationAllowanceLambda = new aws_lambda_1.Function(scope, 'checkCreationAllowanceLambda', {
            code: new aws_lambda_1.AssetCode('../src'),
            handler: 'check-creation-allowance.handler',
            runtime: aws_lambda_1.Runtime.NODEJS_10_X,
            environment: {
                TABLE_NAME: AlfCdkTables_1.instanceTable.name,
                TABLE_STATIC_NAME: AlfCdkTables_1.repoTable.primaryKey,
                PRIMARY_KEY: AlfCdkTables_1.instanceTable.primaryKey,
            },
            logRetention: aws_logs_1.RetentionDays.ONE_DAY,
        });
        this.createOneApi = new aws_lambda_1.Function(scope, 'createItemFunctionApi', {
            code: new aws_lambda_1.AssetCode('src'),
            handler: 'create-api.handler',
            runtime: aws_lambda_1.Runtime.NODEJS_10_X,
            environment: {
                SORT_KEY: AlfCdkTables_1.instanceTable.sortKey
            },
            logRetention: aws_logs_1.RetentionDays.ONE_DAY,
        });
        this.updateOneApi = new aws_lambda_1.Function(scope, 'updateItemFunction', {
            code: new aws_lambda_1.AssetCode('src'),
            handler: 'update-one.handler',
            runtime: aws_lambda_1.Runtime.NODEJS_10_X,
            environment: {
                SORT_KEY: AlfCdkTables_1.instanceTable.sortKey
            },
            logRetention: aws_logs_1.RetentionDays.ONE_DAY,
        });
        new core_1.CfnOutput(scope, 'LGGroupdCreate', {
            value: this.putOneItemLambda.logGroup.logGroupName
        });
        new core_1.CfnOutput(scope, 'LGGroupdCreateInstance', {
            value: this.createInstanceLambda.logGroup.logGroupName
        });
        new core_1.CfnOutput(scope, 'LGGroupdCreateApi', {
            value: this.createOneApi.logGroup.logGroupName
        });
    }
}
exports.AlfCdkLambdas = AlfCdkLambdas;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWxmQ2RrTGFtYmRhcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkFsZkNka0xhbWJkYXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx3Q0FBaUQ7QUFDakQsb0RBQW1FO0FBQ25FLGlEQUEwRDtBQUMxRCxnREFBa0Q7QUFDbEQsbUZBQStIO0FBRy9ILE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxJQUFJLEVBQUUsQ0FBQztBQVlyRCxDQUFDO0FBRUYsTUFBYSxhQUFhO0lBV3hCLFlBQVksS0FBWSxFQUFFLEtBQThCOztRQUN0RCxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUkscUJBQVEsQ0FBQyxLQUFLLEVBQUUsb0JBQW9CLEVBQUU7WUFDNUQsSUFBSSxFQUFFLElBQUksc0JBQVMsQ0FBQyxRQUFRLENBQUM7WUFDN0IsT0FBTyxFQUFFLGlCQUFpQjtZQUMxQixPQUFPLEVBQUUsb0JBQU8sQ0FBQyxXQUFXO1lBQzVCLFdBQVcsRUFBRTtnQkFDWCxVQUFVLEVBQUUsNEJBQWEsQ0FBQyxJQUFJO2dCQUM5QixXQUFXLEVBQUUsNEJBQWEsQ0FBQyxVQUFVO2dCQUNyQyxRQUFRLEVBQUUsNEJBQWEsQ0FBQyxPQUFPO2FBQ2hDO1lBQ0QsWUFBWSxFQUFFLHdCQUFhLENBQUMsT0FBTztTQUNwQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUkscUJBQVEsQ0FBQyxLQUFLLEVBQUUscUJBQXFCLEVBQUU7WUFDN0QsSUFBSSxFQUFFLElBQUksc0JBQVMsQ0FBQyxRQUFRLENBQUM7WUFDN0IsT0FBTyxFQUFFLGlCQUFpQjtZQUMxQixPQUFPLEVBQUUsb0JBQU8sQ0FBQyxXQUFXO1lBQzVCLFdBQVcsRUFBRTtnQkFDWCxVQUFVLEVBQUUsNEJBQWEsQ0FBQyxJQUFJO2dCQUM5QixXQUFXLEVBQUUsNEJBQWEsQ0FBQyxVQUFVO2FBQ3RDO1lBQ0QsWUFBWSxFQUFFLHdCQUFhLENBQUMsT0FBTztTQUNw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QUFRLENBQUMsWUFBWTtTQUNuRCxDQUFDLENBQUM7UUFFSCxJQUFJLGdCQUFTLENBQUMsS0FBSyxFQUFFLHdCQUF3QixFQUFFO1lBQzdDLEtBQUssRUFBRSxJQUFJLENBQUMsb0JBQW9CLENBQUMsUUFBUSxDQUFDLFlBQVk7U0FDdkQsQ0FBQyxDQUFDO1FBRUgsSUFBSSxnQkFBUyxDQUFDLEtBQUssRUFBRSxtQkFBbUIsRUFBRTtZQUN4QyxLQUFLLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsWUFBWTtTQUMvQyxDQUFDLENBQUM7SUFFTCxDQUFDO0NBQ0Y7QUE5SUQsc0NBOElDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2ZuT3V0cHV0LCBTdGFjayB9IGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuaW1wb3J0IHsgRnVuY3Rpb24sIEFzc2V0Q29kZSwgUnVudGltZSB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgaW5zdGFuY2VUYWJsZSwgcmVwb1RhYmxlIH0gZnJvbSAnLi9BbGZDZGtUYWJsZXMnO1xuaW1wb3J0IHsgUmV0ZW50aW9uRGF5cyB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1sb2dzJztcbmltcG9ydCB7IFJvbGUsIFNlcnZpY2VQcmluY2lwYWwsIE1hbmFnZWRQb2xpY3ksIFBvbGljeVN0YXRlbWVudCB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1hcGlnYXRld2F5L25vZGVfbW9kdWxlcy9AYXdzLWNkay9hd3MtaWFtJztcbmltcG9ydCB7IEFsZkluc3RhbmNlc1N0YWNrUHJvcHMgfSBmcm9tICcuLic7XG5cbmNvbnN0IENJX1VTRVJfVE9LRU4gPSBwcm9jZXNzLmVudi5DSV9VU0VSX1RPS0VOIHx8ICcnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEFsZkNka0xhbWJkYXNJbnRlcmZhY2Uge1xuICByZWFkb25seSBnZXRPbmVMYW1iZGE6IEZ1bmN0aW9uLFxuICByZWFkb25seSBnZXRBbGxMYW1iZGE6IEZ1bmN0aW9uLFxuICByZWFkb25seSBnZXRBbGxJbnN0YW5jZXNMYW1iZGE6IEZ1bmN0aW9uLFxuICByZWFkb25seSBkZWxldGVPbmU6IEZ1bmN0aW9uLFxuICByZWFkb25seSBwdXRPbmVJdGVtTGFtYmRhOiBGdW5jdGlvbixcbiAgcmVhZG9ubHkgY3JlYXRlSW5zdGFuY2VMYW1iZGE6IEZ1bmN0aW9uLFxuICByZWFkb25seSBjaGVja0NyZWF0aW9uQWxsb3dhbmNlTGFtYmRhOiBGdW5jdGlvbixcbiAgY3JlYXRlT25lQXBpOiBGdW5jdGlvbixcbiAgdXBkYXRlT25lQXBpOiBGdW5jdGlvbjtcbn07XG5cbmV4cG9ydCBjbGFzcyBBbGZDZGtMYW1iZGFzIGltcGxlbWVudHMgQWxmQ2RrTGFtYmRhc0ludGVyZmFjZXtcbiAgZ2V0T25lTGFtYmRhOiBGdW5jdGlvbjtcbiAgZ2V0QWxsTGFtYmRhOiBGdW5jdGlvbjtcbiAgZ2V0QWxsSW5zdGFuY2VzTGFtYmRhOiBGdW5jdGlvbjtcbiAgZGVsZXRlT25lOiBGdW5jdGlvbjtcbiAgcHV0T25lSXRlbUxhbWJkYTogRnVuY3Rpb247XG4gIGNyZWF0ZUluc3RhbmNlTGFtYmRhOiBGdW5jdGlvbjtcbiAgY2hlY2tDcmVhdGlvbkFsbG93YW5jZUxhbWJkYTogRnVuY3Rpb247XG4gIGNyZWF0ZU9uZUFwaTogRnVuY3Rpb247XG4gIHVwZGF0ZU9uZUFwaTogRnVuY3Rpb247XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IFN0YWNrLCBwcm9wcz86IEFsZkluc3RhbmNlc1N0YWNrUHJvcHMpe1xuICAgIHRoaXMuZ2V0T25lTGFtYmRhID0gbmV3IEZ1bmN0aW9uKHNjb3BlLCAnZ2V0T25lSXRlbUZ1bmN0aW9uJywge1xuICAgICAgY29kZTogbmV3IEFzc2V0Q29kZSgnLi4vc3JjJyksXG4gICAgICBoYW5kbGVyOiAnZ2V0LW9uZS5oYW5kbGVyJyxcbiAgICAgIHJ1bnRpbWU6IFJ1bnRpbWUuTk9ERUpTXzEwX1gsXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBUQUJMRV9OQU1FOiBpbnN0YW5jZVRhYmxlLm5hbWUsXG4gICAgICAgIFBSSU1BUllfS0VZOiBpbnN0YW5jZVRhYmxlLnByaW1hcnlLZXksXG4gICAgICAgIFNPUlRfS0VZOiBpbnN0YW5jZVRhYmxlLnNvcnRLZXlcbiAgICAgIH0sXG4gICAgICBsb2dSZXRlbnRpb246IFJldGVudGlvbkRheXMuT05FX0RBWSxcbiAgICB9KTtcblxuICAgIHRoaXMuZ2V0QWxsTGFtYmRhID0gbmV3IEZ1bmN0aW9uKHNjb3BlLCAnZ2V0QWxsSXRlbXNGdW5jdGlvbicsIHtcbiAgICAgIGNvZGU6IG5ldyBBc3NldENvZGUoJy4uL3NyYycpLFxuICAgICAgaGFuZGxlcjogJ2dldC1hbGwuaGFuZGxlcicsXG4gICAgICBydW50aW1lOiBSdW50aW1lLk5PREVKU18xMF9YLFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgVEFCTEVfTkFNRTogaW5zdGFuY2VUYWJsZS5uYW1lLFxuICAgICAgICBQUklNQVJZX0tFWTogaW5zdGFuY2VUYWJsZS5wcmltYXJ5S2V5XG4gICAgICB9LFxuICAgICAgbG9nUmV0ZW50aW9uOiBSZXRlbnRpb25EYXlzLk9ORV9EQVksXG4gICAgfSk7XG5cbiAgICBjb25zdCByb2xlID0gbmV3IFJvbGUoc2NvcGUsICdSb2xlJywge1xuICAgICAgYXNzdW1lZEJ5OiBuZXcgU2VydmljZVByaW5jaXBhbCgnbGFtYmRhLmFtYXpvbmF3cy5jb20nKSwgICAvLyByZXF1aXJlZFxuICAgICAgbWFuYWdlZFBvbGljaWVzOiBbTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoJ3NlcnZpY2Utcm9sZS9BV1NMYW1iZGFCYXNpY0V4ZWN1dGlvblJvbGUnKV0sXG4gICAgfSk7XG5cbiAgICByb2xlLmFkZFRvUG9saWN5KG5ldyBQb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgcmVzb3VyY2VzOiBbJyonXSxcbiAgICAgIGFjdGlvbnM6IFsnZWMyOionLCAnbG9nczoqJ10gfSkpO1xuXG4gICAgdGhpcy5nZXRBbGxJbnN0YW5jZXNMYW1iZGEgPSBuZXcgRnVuY3Rpb24oc2NvcGUsICdnZXRBbGxJbnN0YW5jZXNGdW5jdGlvbicsIHtcbiAgICAgIGNvZGU6IG5ldyBBc3NldENvZGUoJy4uL3NyYycpLFxuICAgICAgaGFuZGxlcjogJ2dldC1hbGwtaW5zdGFuY2VzLmhhbmRsZXInLFxuICAgICAgcnVudGltZTogUnVudGltZS5OT0RFSlNfMTBfWCxcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIFBSSU1BUllfS0VZOiBpbnN0YW5jZVRhYmxlLnByaW1hcnlLZXksXG4gICAgICAgIFNPUlRfS0VZOiBpbnN0YW5jZVRhYmxlLnNvcnRLZXksXG4gICAgICAgIFNUQUNLX05BTUU6IHNjb3BlLnN0YWNrTmFtZVxuICAgICAgfSxcbiAgICAgIHJvbGU6IHJvbGUsXG4gICAgICBsb2dSZXRlbnRpb246IFJldGVudGlvbkRheXMuT05FX0RBWSxcbiAgICB9KTtcblxuICAgIHRoaXMuZGVsZXRlT25lID0gbmV3IEZ1bmN0aW9uKHNjb3BlLCAnZGVsZXRlSXRlbUZ1bmN0aW9uJywge1xuICAgICAgY29kZTogbmV3IEFzc2V0Q29kZSgnLi4vc3JjJyksXG4gICAgICBoYW5kbGVyOiAnZGVsZXRlLW9uZS5oYW5kbGVyJyxcbiAgICAgIHJ1bnRpbWU6IFJ1bnRpbWUuTk9ERUpTXzEwX1gsXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBUQUJMRV9OQU1FOiBpbnN0YW5jZVRhYmxlLm5hbWUsXG4gICAgICAgIFBSSU1BUllfS0VZOiBpbnN0YW5jZVRhYmxlLnByaW1hcnlLZXksXG4gICAgICAgIFNPUlRfS0VZOiBpbnN0YW5jZVRhYmxlLnNvcnRLZXlcbiAgICAgIH0sXG4gICAgICBsb2dSZXRlbnRpb246IFJldGVudGlvbkRheXMuT05FX0RBWSxcbiAgICB9KTtcblxuICAgIHRoaXMucHV0T25lSXRlbUxhbWJkYSA9IG5ldyBGdW5jdGlvbihzY29wZSwgJ3B1dE9uZUl0ZW0nLCB7XG4gICAgICBjb2RlOiBuZXcgQXNzZXRDb2RlKCcuLi9zcmMnKSxcbiAgICAgIGhhbmRsZXI6ICdjcmVhdGUuaGFuZGxlcicsXG4gICAgICBydW50aW1lOiBSdW50aW1lLk5PREVKU18xMF9YLFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgVEFCTEVfTkFNRTogaW5zdGFuY2VUYWJsZS5uYW1lLFxuICAgICAgICBQUklNQVJZX0tFWTogaW5zdGFuY2VUYWJsZS5wcmltYXJ5S2V5LFxuICAgICAgICBTT1JUX0tFWTogaW5zdGFuY2VUYWJsZS5zb3J0S2V5XG4gICAgICB9LFxuICAgICAgbG9nUmV0ZW50aW9uOiBSZXRlbnRpb25EYXlzLk9ORV9EQVksXG4gICAgfSk7XG5cbiAgICB0aGlzLmNyZWF0ZUluc3RhbmNlTGFtYmRhID0gbmV3IEZ1bmN0aW9uKHNjb3BlLCAnY3JlYXRlSW5zdGFuY2UnLCB7XG4gICAgICBjb2RlOiBuZXcgQXNzZXRDb2RlKCcuLi9zcmMnKSxcbiAgICAgIGhhbmRsZXI6ICdjcmVhdGUtaW5zdGFuY2UuaGFuZGxlcicsXG4gICAgICBydW50aW1lOiBSdW50aW1lLk5PREVKU18xMF9YLFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgUkVQT19UQUJMRSA6IHJlcG9UYWJsZS5uYW1lLFxuICAgICAgICBQUklNQVJZX0tFWTogcmVwb1RhYmxlLnByaW1hcnlLZXksXG4gICAgICAgIENJX1VTRVJfVE9LRU46IENJX1VTRVJfVE9LRU4sXG4gICAgICAgIFNFQ1VSSVRZX0dST1VQOiAnZGVmYXVsdCcsXG4gICAgICAgIFNUQUNLX05BTUU6IHNjb3BlLnN0YWNrTmFtZSxcbiAgICAgICAgSU1BR0VfSUQ6IHByb3BzPy5pbWFnZUlkIHx8ICcnXG4gICAgICB9LFxuICAgICAgcm9sZTogcm9sZSxcbiAgICAgIGxvZ1JldGVudGlvbjogUmV0ZW50aW9uRGF5cy5PTkVfREFZLFxuICAgIH0pO1xuXG4gICAgdGhpcy5jaGVja0NyZWF0aW9uQWxsb3dhbmNlTGFtYmRhID0gbmV3IEZ1bmN0aW9uKHNjb3BlLCAnY2hlY2tDcmVhdGlvbkFsbG93YW5jZUxhbWJkYScsIHtcbiAgICAgIGNvZGU6IG5ldyBBc3NldENvZGUoJy4uL3NyYycpLFxuICAgICAgaGFuZGxlcjogJ2NoZWNrLWNyZWF0aW9uLWFsbG93YW5jZS5oYW5kbGVyJyxcbiAgICAgIHJ1bnRpbWU6IFJ1bnRpbWUuTk9ERUpTXzEwX1gsXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBUQUJMRV9OQU1FOiBpbnN0YW5jZVRhYmxlLm5hbWUsXG4gICAgICAgIFRBQkxFX1NUQVRJQ19OQU1FOiByZXBvVGFibGUucHJpbWFyeUtleSxcbiAgICAgICAgUFJJTUFSWV9LRVk6IGluc3RhbmNlVGFibGUucHJpbWFyeUtleSxcbiAgICAgIH0sXG4gICAgICBsb2dSZXRlbnRpb246IFJldGVudGlvbkRheXMuT05FX0RBWSxcbiAgICB9KTtcblxuICAgIHRoaXMuY3JlYXRlT25lQXBpID0gbmV3IEZ1bmN0aW9uKHNjb3BlLCAnY3JlYXRlSXRlbUZ1bmN0aW9uQXBpJywge1xuICAgICAgY29kZTogbmV3IEFzc2V0Q29kZSgnc3JjJyksXG4gICAgICBoYW5kbGVyOiAnY3JlYXRlLWFwaS5oYW5kbGVyJyxcbiAgICAgIHJ1bnRpbWU6IFJ1bnRpbWUuTk9ERUpTXzEwX1gsXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBTT1JUX0tFWTogaW5zdGFuY2VUYWJsZS5zb3J0S2V5XG4gICAgICB9LFxuICAgICAgbG9nUmV0ZW50aW9uOiBSZXRlbnRpb25EYXlzLk9ORV9EQVksXG4gICAgfSk7XG5cbiAgICB0aGlzLnVwZGF0ZU9uZUFwaSA9IG5ldyBGdW5jdGlvbihzY29wZSwgJ3VwZGF0ZUl0ZW1GdW5jdGlvbicsIHtcbiAgICAgIGNvZGU6IG5ldyBBc3NldENvZGUoJ3NyYycpLFxuICAgICAgaGFuZGxlcjogJ3VwZGF0ZS1vbmUuaGFuZGxlcicsXG4gICAgICBydW50aW1lOiBSdW50aW1lLk5PREVKU18xMF9YLFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgU09SVF9LRVk6IGluc3RhbmNlVGFibGUuc29ydEtleVxuICAgICAgfSxcbiAgICAgIGxvZ1JldGVudGlvbjogUmV0ZW50aW9uRGF5cy5PTkVfREFZLFxuICAgIH0pO1xuXG4gICAgbmV3IENmbk91dHB1dChzY29wZSwgJ0xHR3JvdXBkQ3JlYXRlJywge1xuICAgICAgdmFsdWU6IHRoaXMucHV0T25lSXRlbUxhbWJkYS5sb2dHcm91cC5sb2dHcm91cE5hbWVcbiAgICB9KTtcblxuICAgIG5ldyBDZm5PdXRwdXQoc2NvcGUsICdMR0dyb3VwZENyZWF0ZUluc3RhbmNlJywge1xuICAgICAgdmFsdWU6IHRoaXMuY3JlYXRlSW5zdGFuY2VMYW1iZGEubG9nR3JvdXAubG9nR3JvdXBOYW1lXG4gICAgfSk7XG5cbiAgICBuZXcgQ2ZuT3V0cHV0KHNjb3BlLCAnTEdHcm91cGRDcmVhdGVBcGknLCB7XG4gICAgICB2YWx1ZTogdGhpcy5jcmVhdGVPbmVBcGkubG9nR3JvdXAubG9nR3JvdXBOYW1lXG4gICAgfSk7XG5cbiAgfVxufVxuIl19